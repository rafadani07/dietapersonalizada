<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fitness Pro Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .gradient-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .gradient-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .water-wave {
      animation: wave 3s ease-in-out infinite;
    }
    
    @keyframes wave {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .bluetooth-scan {
      animation: scan 2s linear infinite;
    }
    
    @keyframes scan {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full w-full overflow-auto bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">
  <div class="w-full min-h-full"><!-- Header -->
   <header class="w-full glass-effect sticky top-0 z-50 shadow-2xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
       <div class="w-12 h-12 gradient-primary rounded-2xl flex items-center justify-center shadow-lg">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
       </div>
       <div>
        <h1 id="app-title" class="text-xl sm:text-2xl font-bold">Fitness Pro Tracker</h1>
        <p class="text-xs text-gray-400 hidden sm:block">v2.0 Premium</p>
       </div>
      </div>
      <div class="flex items-center space-x-2 sm:space-x-4"><button id="sync-indicator" class="hidden px-3 py-2 glass-effect rounded-xl text-xs font-medium"> <span class="flex items-center space-x-2"> <span class="w-2 h-2 bg-green-400 rounded-full pulse-animation"></span> <span class="hidden sm:inline">Sincronizado</span> </span> </button> <button id="menu-btn" class="p-2 rounded-xl hover:bg-white/10 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg></button>
      </div>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8"><!-- Welcome Screen -->
    <div id="welcome-screen" class="space-y-8">
     <div class="text-center space-y-6 py-8 sm:py-16">
      <div class="relative w-32 h-32 mx-auto">
       <div class="absolute inset-0 gradient-primary rounded-full opacity-20 animate-pulse"></div>
       <div class="relative w-32 h-32 gradient-primary rounded-full flex items-center justify-center shadow-2xl">
        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
       </div>
      </div>
      <div class="space-y-3">
       <h2 id="welcome-title" class="text-4xl sm:text-6xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-blue-400 bg-clip-text text-transparent">Seu Personal Trainer Digital</h2>
       <p id="welcome-subtitle" class="text-gray-300 text-lg sm:text-xl max-w-2xl mx-auto px-4">Treino e nutri√ß√£o personalizados com tecnologia avan√ßada</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center pt-8"><button id="start-btn" class="w-full sm:w-auto px-8 py-4 gradient-primary rounded-2xl font-bold text-lg shadow-2xl hover:scale-105 transition-all"> Come√ßar Agora </button> <button id="bluetooth-welcome-btn" class="w-full sm:w-auto px-8 py-4 glass-effect rounded-2xl font-semibold text-lg hover:bg-white/10 transition-all flex items-center justify-center space-x-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
        </svg><span>Conectar Balan√ßa</span> </button>
      </div>
      <!-- Saved workouts section (welcome) -->
      <div id="saved-workouts-section" class="mt-6 hidden">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-bold text-lg">Seus Treinos</h4>
          <span id="workout-count-badge" class="px-2 py-1 bg-purple-500/20 rounded-lg text-xs font-semibold">0</span>
        </div>
        <div id="saved-workouts-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      </div>
      <div class="pt-8 glass-effect rounded-2xl p-6 max-w-3xl mx-auto">
       <h3 class="font-bold text-lg mb-4 text-purple-300">‚ú® Recursos Premium</h3>
       <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
        <div class="flex items-center space-x-2">
         <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg><span>Bluetooth BLE</span>
        </div>
        <div class="flex items-center space-x-2">
         <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg><span>Tracking de √Ågua</span>
        </div>
        <div class="flex items-center space-x-2">
         <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
         </svg><span>Treinos Avan√ßados</span>
        </div>
       </div>
      </div>
    </div>

    <!-- Saved plans preview on welcome screen -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 -mt-6">
        <div class="glass-effect rounded-2xl p-4 border border-white/10">
          <h4 class="font-bold text-lg mb-2">Treinos Salvos</h4>
          <div id="welcome-saved-workouts" class="space-y-2"></div>
        </div>
        <div class="glass-effect rounded-2xl p-4 border border-white/10">
          <h4 class="font-bold text-lg mb-2">Dietas Salvas</h4>
          <div id="welcome-saved-diets" class="space-y-2"></div>
        </div>
      </div>
    </div>

    </div><!-- Profile Setup -->
    <div id="profile-setup" class="hidden space-y-6 fade-in">
     <div class="glass-effect rounded-2xl p-6 sm:p-8 shadow-2xl">
      <div class="flex items-center space-x-3 mb-6">
       <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
       </div>
       <h3 class="text-2xl font-bold">Configure seu Perfil</h3>
      </div><!-- Bluetooth Connection -->
      <div class="mb-8 p-6 glass-effect rounded-xl border border-blue-500/30">
       <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
         <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
         </svg>
         <div>
          <h4 class="font-semibold">Balan√ßa Inteligente</h4>
          <p class="text-xs text-gray-400">Conecte via Bluetooth para leitura autom√°tica</p>
         </div>
        </div><button id="bluetooth-btn" class="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg font-medium transition-all text-sm"> <span id="bluetooth-btn-text">Conectar</span> </button>
       </div>
       <div id="bluetooth-status" class="text-sm text-gray-400"></div>
       <div id="bluetooth-data" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
      </div><!-- Manual Entry Form -->
      <form id="profile-form" class="space-y-6">
       <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"><!-- Body Metrics -->
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="weight">Peso (kg)</label> <input type="number" id="weight" step="0.1" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="height">Altura (cm)</label> <input type="number" id="height" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="age">Idade</label> <input type="number" id="age" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="gender">Sexo</label> <select id="gender" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required> <option value="male" class="bg-gray-900">Masculino</option> <option value="female" class="bg-gray-900">Feminino</option> </select>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="bodyfat">% Gordura</label> <input type="number" id="bodyfat" step="0.1" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="muscle">Massa Muscular (kg)</label> <input type="number" id="muscle" step="0.1" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="activity">NÔøΩÔøΩvel de Atividade</label> <select id="activity" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required> <option value="1.2" class="bg-gray-900">Sedent√°rio</option> <option value="1.375" class="bg-gray-900">Levemente ativo (1-2x/sem)</option> <option value="1.55" class="bg-gray-900">Moderado (3-5x/sem)</option> <option value="1.725" class="bg-gray-900">Muito ativo (6-7x/sem)</option> <option value="1.9" class="bg-gray-900">Atleta (2x/dia)</option> </select>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="goal">Objetivo</label> <select id="goal" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required> <option value="lose" class="bg-gray-900">Perder Gordura</option> <option value="maintain" class="bg-gray-900">Manter Peso</option> <option value="gain" class="bg-gray-900">Ganhar Massa</option> </select>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="training-days">Dias de Treino</label> <select id="training-days" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required> <option value="3" class="bg-gray-900">3 dias/semana</option> <option value="4" class="bg-gray-900">4 dias/semana</option> <option value="5" class="bg-gray-900">5 dias/semana</option> <option value="6" class="bg-gray-900">6 dias/semana</option> </select>
        </div>
        <div><label class="block text-sm font-medium mb-2 text-gray-300" for="level">N√≠vel de Treino</label> <select id="level" class="w-full px-4 py-3 glass-effect border border-white/20 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required> <option value="beginner" class="bg-gray-900">Iniciante</option> <option value="intermediate" class="bg-gray-900">Intermedi√°rio</option> <option value="advanced" class="bg-gray-900">Avan√ßado</option> </select>
        </div>
       </div><button type="submit" id="generate-plan-btn" class="w-full px-6 py-4 gradient-primary rounded-xl font-bold text-lg shadow-2xl hover:scale-105 transition-all"> Gerar Plano Personalizado </button>
      </form>
     </div>
    </div><!-- Dashboard -->
    <div id="dashboard" class="hidden space-y-6 fade-in"><!-- Quick Stats -->
     <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
      <div class="glass-effect rounded-2xl p-4 sm:p-6 border border-purple-500/30 card-hover">
       <div class="flex items-center justify-between mb-2"><span class="text-xs sm:text-sm font-medium text-gray-300">TMB</span>
        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
       </div>
       <p id="tmb-value" class="text-2xl sm:text-3xl font-bold">0</p>
       <p class="text-xs text-gray-400 mt-1">kcal/dia</p>
      </div>
      <div class="glass-effect rounded-2xl p-4 sm:p-6 border border-pink-500/30 card-hover">
       <div class="flex items-center justify-between mb-2"><span class="text-xs sm:text-sm font-medium text-gray-300">TDEE</span>
        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-pink-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
       </div>
       <p id="tdee-value" class="text-2xl sm:text-3xl font-bold">0</p>
       <p class="text-xs text-gray-400 mt-1">kcal/dia</p>
      </div>
      <div class="glass-effect rounded-2xl p-4 sm:p-6 border border-blue-500/30 card-hover">
       <div class="flex items-center justify-between mb-2"><span class="text-xs sm:text-sm font-medium text-gray-300">Meta</span>
        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <p id="goal-calories" class="text-2xl sm:text-3xl font-bold">0</p>
       <p class="text-xs text-gray-400 mt-1">kcal/dia</p>
      </div>
      <div class="glass-effect rounded-2xl p-4 sm:p-6 border border-green-500/30 card-hover">
       <div class="flex items-center justify-between mb-2"><span class="text-xs sm:text-sm font-medium text-gray-300">Prote√≠na</span>
        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
        </svg>
       </div>
       <p id="protein-value" class="text-2xl sm:text-3xl font-bold">0g</p>
       <p class="text-xs text-gray-400 mt-1">por dia</p>
      </div>
     </div><!-- Water Tracker -->
     <div class="glass-effect rounded-2xl p-6 sm:p-8 border border-white/10">
      <div class="flex items-center justify-between mb-6">
       <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
         <svg class="w-6 h-6 text-blue-400 water-wave" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
         </svg>
        </div>
        <div>
         <h3 id="water-goal-label" class="text-lg sm:text-xl font-bold">Meta Di√°ria de √Ågua</h3>
         <p class="text-xs sm:text-sm text-gray-400">Mantenha-se hidratado</p>
        </div>
       </div>
       <div class="text-right">
        <p class="text-2xl sm:text-3xl font-bold"><span id="water-current">0</span>L</p>
        <p class="text-xs sm:text-sm text-gray-400">de <span id="water-goal">0</span>L</p>
       </div>
      </div>
      <div class="relative w-full bg-gray-700/50 rounded-full h-6 overflow-hidden mb-4">
       <div id="water-progress" class="absolute top-0 left-0 h-full gradient-success transition-all duration-500" style="width: 0%"></div>
       <div class="absolute inset-0 flex items-center justify-center"><span id="water-percent" class="text-xs font-bold text-white drop-shadow-lg">0%</span>
       </div>
      </div>
      <div class="flex flex-wrap gap-2"><button class="water-add-btn flex-1 sm:flex-none px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg font-medium transition-all text-sm" data-amount="0.25"> + 250ml </button> <button class="water-add-btn flex-1 sm:flex-none px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg font-medium transition-all text-sm" data-amount="0.5"> + 500ml </button> <button class="water-add-btn flex-1 sm:flex-none px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 rounded-lg font-medium transition-all text-sm" data-amount="1"> + 1L </button> <button id="water-reset-btn" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg font-medium transition-all text-sm"> Reset </button>
      </div>
     </div><!-- Macros Chart -->
     <div class="glass-effect rounded-2xl p-6 sm:p-8 border border-white/10">
      <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center">
       <svg class="w-6 h-6 sm:w-7 sm:h-7 mr-3 text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
       </svg> Distribui√ß√£o de Macros</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
       <div class="space-y-4">
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-medium text-gray-300">Prote√≠na</span> <span id="protein-grams" class="text-sm font-bold text-green-400">0g (0%)</span>
         </div>
         <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
          <div id="protein-bar" class="bg-gradient-to-r from-green-400 to-green-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
         </div>
        </div>
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-medium text-gray-300">Carboidratos</span> <span id="carbs-grams" class="text-sm font-bold text-blue-400">0g (0%)</span>
         </div>
         <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
          <div id="carbs-bar" class="bg-gradient-to-r from-blue-400 to-blue-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
         </div>
        </div>
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-medium text-gray-300">Gorduras</span> <span id="fat-grams" class="text-sm font-bold text-yellow-400">0g (0%)</span>
         </div>
         <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
          <div id="fat-bar" class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
         </div>
        </div>
       </div>
       <div class="flex items-center justify-center">
        <canvas id="macros-chart" class="max-w-full" style="max-height: 250px;"></canvas>
       </div>
      </div>
     </div><!-- Workout Plan -->
     <div class="glass-effect rounded-2xl p-6 sm:p-8 border border-white/10">
      <div class="flex items-center justify-between mb-6">
       <h3 class="text-xl sm:text-2xl font-bold flex items-center">
        <svg class="w-6 h-6 sm:w-7 sm:h-7 mr-3 text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg> Treino Personalizado</h3><span id="workout-level-badge" class="px-3 py-1 bg-purple-500/20 rounded-lg text-xs font-semibold"></span>
      </div>
      <div id="workout-plan" class="space-y-4"></div>
      <!-- Save workout UI -->
      <div class="mt-4 p-4 bg-gray-800/30 rounded-xl border border-white/10">
        <h4 class="text-lg font-bold mb-3">Salvar Treino</h4>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="save-workout-name" placeholder="Nome do treino (ex: Treino do Rafael)" class="px-4 py-3 glass-effect border border-white/10 rounded-xl text-white" />
          <input id="save-workout-person" placeholder="Pessoa (ex: Rafael)" class="px-4 py-3 glass-effect border border-white/10 rounded-xl text-white" />
          <button id="save-workout-btn" class="px-4 py-3 gradient-primary rounded-xl font-semibold">Salvar Treino</button>
        </div>
        <p class="text-xs text-gray-400 mt-3">Treinos salvos:</p>
        <ul id="saved-workouts" class="mt-2 space-y-2 list-none p-0"></ul>
      </div>
     </div><!-- Diet Plan -->
     <div class="glass-effect rounded-2xl p-6 sm:p-8 border border-white/10">
      <h3 class="text-xl sm:text-2xl font-bold mb-6 flex items-center">
       <svg class="w-6 h-6 sm:w-7 sm:h-7 mr-3 text-pink-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
       </svg> Plano Alimentar</h3>
      <div id="diet-plan" class="space-y-4"></div>
     </div><!-- Action Buttons -->
     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><button id="edit-profile-btn" class="px-6 py-4 glass-effect hover:bg-white/10 rounded-xl font-semibold transition-all border border-white/20 flex items-center justify-center space-x-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
       </svg><span>Editar Perfil</span> </button> <button id="new-plan-btn" class="px-6 py-4 gradient-primary rounded-xl font-semibold shadow-2xl hover:scale-105 transition-all flex items-center justify-center space-x-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
       </svg><span>Atualizar Plano</span> </button>
     </div>
    </div>
   </main>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: "Fitness Pro Tracker",
      welcome_title: "Seu Personal Trainer Digital",
      welcome_subtitle: "Treino e nutri√ß√£o personalizados com tecnologia avan√ßada",
      water_goal_label: "Meta Di√°ria de √Ågua",
      bluetooth_button_text: "Conectar Balan√ßa"
    };

    let currentConfig = { ...defaultConfig };
    let userData = null;
    let calculatedData = null;
    let waterIntake = 0;
    let waterGoal = 0;
    let macrosChart = null;

    // Advanced Exercise Database
    const advancedExercises = {
      chest: {
        beginner: [
          { name: "Flex√£o Inclinada", sets: "3", reps: "8-10", rest: "90s", note: "M√£os em superf√≠cie elevada" },
          { name: "Supino M√°quina", sets: "3", reps: "10-12", rest: "60s", note: "Controle o movimento" },
          { name: "Crucifixo M√°quina", sets: "3", reps: "12-15", rest: "60s", note: "Alongue bem no final" }
        ],
        intermediate: [
          { name: "Supino Reto", sets: "4", reps: "8-12", rest: "90s", note: "Barra deve tocar o peito" },
          { name: "Supino Inclinado", sets: "3", reps: "10-12", rest: "90s", note: "Foco na parte superior" },
          { name: "Crucifixo Halteres", sets: "3", reps: "12-15", rest: "60s", note: "Cotovelos levemente flexionados" },
          { name: "Flex√£o Diamante", sets: "3", reps: "at√© falha", rest: "60s", note: "M√£os pr√≥ximas" }
        ],
        advanced: [
          { name: "Supino Reto", sets: "5", reps: "6-8", rest: "120s", note: "Carga progressiva" },
          { name: "Supino Inclinado", sets: "4", reps: "8-10", rest: "90s", note: "45¬∞ de inclina√ß√£o" },
          { name: "Supino Declinado", sets: "3", reps: "10-12", rest: "90s", note: "Parte inferior do peitoral" },
          { name: "Crucifixo Inclinado", sets: "3", reps: "12-15", rest: "60s", note: "Alongamento m√°ximo" },
          { name: "Pullover", sets: "3", reps: "12-15", rest: "60s", note: "Expande a caixa tor√°cica" }
        ]
      },
      back: {
        beginner: [
          { name: "Puxada Frontal M√°quina", sets: "3", reps: "10-12", rest: "90s", note: "Pegada m√©dia" },
          { name: "Remada M√°quina", sets: "3", reps: "10-12", rest: "60s", note: "Puxe at√© o abd√¥men" },
          { name: "Remada Unilateral", sets: "3", reps: "10-12", rest: "60s", note: "Cada bra√ßo" }
        ],
        intermediate: [
          { name: "Barra Fixa", sets: "4", reps: "6-10", rest: "120s", note: "Amplitude completa" },
          { name: "Remada Curvada", sets: "4", reps: "8-12", rest: "90s", note: "Costas retas" },
          { name: "Puxada Frontal", sets: "3", reps: "10-12", rest: "90s", note: "Pegada larga" },
          { name: "Remada Cavalinho", sets: "3", reps: "10-12", rest: "60s", note: "Neutra" }
        ],
        advanced: [
          { name: "Barra Fixa Pegada Larga", sets: "5", reps: "8-12", rest: "120s", note: "Peito na barra" },
          { name: "Remada Curvada Pronada", sets: "4", reps: "8-10", rest: "90s", note: "T√©cnica perfeita" },
          { name: "Levantamento Terra", sets: "4", reps: "6-8", rest: "120s", note: "Lombar neutra" },
          { name: "Puxada Triangular", sets: "3", reps: "10-12", rest: "90s", note: "Puxe at√© o peito" },
          { name: "Remada Unilateral", sets: "3", reps: "12-15", rest: "60s", note: "Cada lado" }
        ]
      },
      legs: {
        beginner: [
          { name: "Leg Press 45¬∞", sets: "3", reps: "12-15", rest: "90s", note: "Joelhos alinhados" },
          { name: "Extensora", sets: "3", reps: "12-15", rest: "60s", note: "Contraia no topo" },
          { name: "Flexora Deitada", sets: "3", reps: "12-15", rest: "60s", note: "Movimento controlado" },
          { name: "Panturrilha Sentado", sets: "3", reps: "15-20", rest: "45s", note: "Amplitude total" }
        ],
        intermediate: [
          { name: "Agachamento Livre", sets: "4", reps: "8-12", rest: "120s", note: "Profundidade total" },
          { name: "Leg Press", sets: "4", reps: "10-15", rest: "90s", note: "P√©s na largura dos ombros" },
          { name: "Stiff", sets: "3", reps: "10-12", rest: "90s", note: "Lombar reta" },
          { name: "Cadeira Extensora", sets: "3", reps: "12-15", rest: "60s", note: "Pico de contra√ß√£o" },
          { name: "Flexora", sets: "3", reps: "12-15", rest: "60s", note: "Controle a descida" }
        ],
        advanced: [
          { name: "Agachamento Livre", sets: "5", reps: "6-10", rest: "180s", note: "ATG - Ass to Grass" },
          { name: "Agachamento Frontal", sets: "4", reps: "8-12", rest: "120s", note: "Quadr√≠ceps isolado" },
          { name: "Leg Press Unilateral", sets: "4", reps: "10-12", rest: "90s", note: "Cada perna" },
          { name: "Stiff Romeno", sets: "4", reps: "8-10", rest: "90s", note: "Posterior de coxa" },
          { name: "B√∫lgaro", sets: "3", reps: "10-12", rest: "90s", note: "Cada perna" },
          { name: "Panturrilha em P√©", sets: "4", reps: "12-15", rest: "60s", note: "3s no topo" }
        ]
      },
      shoulders: {
        beginner: [
          { name: "Desenvolvimento M√°quina", sets: "3", reps: "10-12", rest: "90s", note: "Trajet√≥ria guiada" },
          { name: "Eleva√ß√£o Lateral M√°quina", sets: "3", reps: "12-15", rest: "60s", note: "Cotovelos levemente flexionados" },
          { name: "Eleva√ß√£o Frontal Halteres", sets: "3", reps: "12-15", rest: "60s", note: "Alternado" }
        ],
        intermediate: [
          { name: "Desenvolvimento com Barra", sets: "4", reps: "8-12", rest: "90s", note: "Sentado ou em p√©" },
          { name: "Eleva√ß√£o Lateral", sets: "3", reps: "12-15", rest: "60s", note: "Cotovelos altos" },
          { name: "Eleva√ß√£o Frontal", sets: "3", reps: "12-15", rest: "60s", note: "Barra ou halteres" },
          { name: "Crucifixo Inverso", sets: "3", reps: "12-15", rest: "60s", note: "Posterior" }
        ],
        advanced: [
          { name: "Desenvolvimento Arnold", sets: "4", reps: "8-12", rest: "90s", note: "Rota√ß√£o completa" },
          { name: "Desenvolvimento com Halteres", sets: "4", reps: "8-10", rest: "90s", note: "Amplitude total" },
          { name: "Eleva√ß√£o Lateral Drop Set", sets: "3", reps: "12-15-20", rest: "90s", note: "3 cargas sequenciais" },
          { name: "Remada Alta", sets: "3", reps: "10-12", rest: "60s", note: "Barra ou cabo" },
          { name: "Face Pull", sets: "4", reps: "15-20", rest: "45s", note: "Posterior + manguito" }
        ]
      },
      arms: {
        beginner: [
          { name: "Rosca Direta Barra", sets: "3", reps: "10-12", rest: "60s", note: "Cotovelos fixos" },
          { name: "Tr√≠ceps Polia", sets: "3", reps: "10-12", rest: "60s", note: "Corda ou barra" },
          { name: "Rosca Martelo", sets: "3", reps: "10-12", rest: "60s", note: "Antebra√ßos tamb√©m" }
        ],
        intermediate: [
          { name: "Rosca Direta Barra W", sets: "3", reps: "10-12", rest: "60s", note: "B√≠ceps cabe√ßa longa" },
          { name: "Rosca Alternada", sets: "3", reps: "10-12", rest: "60s", note: "Supina√ß√£o total" },
          { name: "Tr√≠ceps Testa", sets: "3", reps: "10-12", rest: "60s", note: "Cabe√ßa longa" },
          { name: "Tr√≠ceps Corda", sets: "3", reps: "12-15", rest: "60s", note: "Abertura no final" }
        ],
        advanced: [
          { name: "Rosca Direta 21's", sets: "3", reps: "21", rest: "90s", note: "7+7+7 reps" },
          { name: "Rosca Scott", sets: "4", reps: "8-10", rest: "60s", note: "Pico de contra√ß√£o" },
          { name: "Rosca Concentrada", sets: "3", reps: "10-12", rest: "60s", note: "Cada bra√ßo" },
          { name: "Tr√≠ceps Franc√™s", sets: "4", reps: "8-10", rest: "90s", note: "Alongamento total" },
          { name: "Paralelas Tr√≠ceps", sets: "3", reps: "10-15", rest: "90s", note: "Corpo inclinado √† frente" },
          { name: "Tr√≠ceps Coice", sets: "3", reps: "12-15", rest: "45s", note: "Cada bra√ßo" }
        ]
      },
      core: {
        beginner: [
          { name: "Prancha", sets: "3", reps: "30-45s", rest: "60s", note: "Corpo alinhado" },
          { name: "Abdominal Supra", sets: "3", reps: "15-20", rest: "45s", note: "Lombar no ch√£o" },
          { name: "ElevaÔøΩÔøΩÔøΩÔøΩ√£o de Pernas", sets: "3", reps: "10-15", rest: "45s", note: "Controlado" }
        ],
        intermediate: [
          { name: "Prancha Lateral", sets: "3", reps: "30-45s", rest: "60s", note: "Cada lado" },
          { name: "Abdominal Bike", sets: "3", reps: "20-30", rest: "45s", note: "Rota√ß√£o total" },
          { name: "Russian Twist", sets: "3", reps: "20-30", rest: "45s", note: "Com peso" },
          { name: "Mountain Climbers", sets: "3", reps: "30s", rest: "60s", note: "Ritmo moderado" }
        ],
        advanced: [
          { name: "Prancha com Eleva√ß√£o", sets: "3", reps: "45-60s", rest: "60s", note: "Alternar bra√ßos" },
          { name: "Abdominal Completo", sets: "4", reps: "15-20", rest: "45s", note: "Toque nos p√©s" },
          { name: "Windshield Wipers", sets: "3", reps: "10-15", rest: "60s", note: "Pendular pernas" },
          { name: "Dragon Flag", sets: "3", reps: "6-10", rest: "90s", note: "Movimento avan√ßado" },
          { name: "Ab Wheel", sets: "3", reps: "10-15", rest: "60s", note: "Amplitude total" }
        ]
      }
    };

    // Workout Splits by Days and Level
    const workoutPrograms = {
      3: {
        beginner: [
          { name: "Full Body A", groups: [["chest", 2], ["back", 2], ["legs", 2], ["core", 2]] },
          { name: "Full Body B", groups: [["shoulders", 2], ["arms", 2], ["legs", 2], ["core", 2]] },
          { name: "Full Body C", groups: [["chest", 2], ["back", 2], ["legs", 2], ["core", 2]] }
        ],
        intermediate: [
          { name: "Push", groups: [["chest", 3], ["shoulders", 3], ["arms", 2]] },
          { name: "Pull", groups: [["back", 4], ["arms", 2], ["core", 2]] },
          { name: "Legs", groups: [["legs", 5], ["core", 2]] }
        ],
        advanced: [
          { name: "Push", groups: [["chest", 4], ["shoulders", 4], ["arms", 2]] },
          { name: "Pull", groups: [["back", 5], ["arms", 2]] },
          { name: "Legs", groups: [["legs", 6], ["core", 3]] }
        ]
      },
      4: {
        beginner: [
          { name: "Upper A", groups: [["chest", 2], ["back", 2], ["arms", 1]] },
          { name: "Lower A", groups: [["legs", 3], ["core", 2]] },
          { name: "Upper B", groups: [["shoulders", 2], ["back", 2], ["arms", 1]] },
          { name: "Lower B", groups: [["legs", 3], ["core", 2]] }
        ],
        intermediate: [
          { name: "Peito/Tr√≠ceps", groups: [["chest", 4], ["arms", 3], ["core", 2]] },
          { name: "Costas/B√≠ceps", groups: [["back", 4], ["arms", 3]] },
          { name: "Pernas", groups: [["legs", 5], ["core", 2]] },
          { name: "Ombros", groups: [["shoulders", 4], ["core", 2]] }
        ],
        advanced: [
          { name: "Peito", groups: [["chest", 5], ["core", 2]] },
          { name: "Costas", groups: [["back", 5], ["core", 2]] },
          { name: "Pernas", groups: [["legs", 6]] },
          { name: "Ombros/Bra√ßos", groups: [["shoulders", 4], ["arms", 4]] }
        ]
      },
      5: {
        beginner: [
          { name: "Peito", groups: [["chest", 3], ["core", 2]] },
          { name: "Costas", groups: [["back", 3], ["core", 2]] },
          { name: "Pernas", groups: [["legs", 3], ["core", 2]] },
          { name: "Ombros", groups: [["shoulders", 3], ["core", 2]] },
          { name: "Bra√ßos", groups: [["arms", 3], ["core", 2]] }
        ],
        intermediate: [
          { name: "Peito", groups: [["chest", 4], ["arms", 2]] },
          { name: "Costas", groups: [["back", 4], ["arms", 2]] },
          { name: "Pernas", groups: [["legs", 5], ["core", 2]] },
          { name: "Ombros", groups: [["shoulders", 4], ["core", 2]] },
          { name: "Bra√ßos", groups: [["arms", 5], ["core", 2]] }
        ],
        advanced: [
          { name: "Peito", groups: [["chest", 5]] },
          { name: "Costas", groups: [["back", 5]] },
          { name: "Pernas", groups: [["legs", 6]] },
          { name: "Ombros", groups: [["shoulders", 5]] },
          { name: "Bra√ßos/Core", groups: [["arms", 6], ["core", 3]] }
        ]
      },
      6: {
        beginner: [
          { name: "Peito", groups: [["chest", 3]] },
          { name: "Costas", groups: [["back", 3]] },
          { name: "Pernas", groups: [["legs", 3]] },
          { name: "Ombros", groups: [["shoulders", 3]] },
          { name: "Bra√ßos", groups: [["arms", 3]] },
          { name: "Core/Cardio", groups: [["core", 3]] }
        ],
        intermediate: [
          { name: "Peito", groups: [["chest", 4]] },
          { name: "Costas", groups: [["back", 4]] },
          { name: "Pernas", groups: [["legs", 5]] },
          { name: "Ombros", groups: [["shoulders", 4]] },
          { name: "Bra√ßos", groups: [["arms", 5]] },
          { name: "Core/Cardio", groups: [["core", 3]] }
        ],
        advanced: [
          { name: "Peito", groups: [["chest", 5]] },
          { name: "Costas", groups: [["back", 5]] },
          { name: "Pernas A", groups: [["legs", 6]] },
          { name: "Ombros", groups: [["shoulders", 5]] },
          { name: "Bra√ßos", groups: [["arms", 6]] },
          { name: "Pernas B/Core", groups: [["legs", 4], ["core", 3]] }
        ]
      }
    };

    // Meal Database
    const mealDatabase = [
      {
        name: "Caf√© da Manh√£",
        icon: "‚òÄÔ∏è",
        options: {
          lose: ["Ovos mexidos (3 claras + 1 inteiro)", "Aveia (50g)", "Frutas vermelhas (100g)", "Caf√© preto"],
          maintain: ["Ovos mexidos (2 inteiros)", "Aveia (60g)", "Banana m√©dia", "Pasta de amendoim (15g)"],
          gain: ["Ovos mexidos (3 inteiros)", "Aveia (80g)", "Banana", "Pasta de amendoim (20g)", "Whey (30g)"]
        }
      },
      {
        name: "Lanche da Manh√£",
        icon: "ü•§",
        options: {
          lose: ["Iogurte grego 0% (150g)", "Mix de castanhas (20g)"],
          maintain: ["Iogurte grego (170g)", "Granola (30g)", "Mel (10g)"],
          gain: ["Whey protein (30g)", "Banana", "Pasta de amendoim (20g)", "Aveia (40g)"]
        }
      },
      {
        name: "Almo√ßo",
        icon: "üçΩÔ∏è",
        options: {
          lose: ["Frango grelhado (150g)", "Arroz integral (80g cru)", "Br√≥colis (150g)", "Salada verde"],
          maintain: ["Frango/Peixe (180g)", "Arroz integral (100g cru)", "Batata doce (150g)", "Legumes (200g)"],
          gain: ["Carne vermelha magra (200g)", "Arroz integral (120g cru)", "Batata doce (200g)", "Legumes (250g)", "Azeite (1 colher)"]
        }
      },
      {
        name: "Lanche da Tarde",
        icon: "ü•ó",
        options: {
          lose: ["Atum em √°gua (1 lata)", "Salada", "Torradas integrais (2)"],
          maintain: ["Sandu√≠che natural (p√£o integral + frango + salada)", "Suco natural"],
          gain: ["P√£o integral (2 fatias)", "Peito de peru (100g)", "Queijo branco (50g)", "Abacate (50g)"]
        }
      },
      {
        name: "Pr√©-Treino",
        icon: "‚ö°",
        options: {
          lose: ["Banana pequena", "Caf√©"],
          maintain: ["Tapioca (50g) com geleia", "Caf√©"],
          gain: ["Batata doce (150g)", "Whey (30g)", "Mel (10g)"]
        }
      },
      {
        name: "P√≥s-Treino",
        icon: "üí™",
        options: {
          lose: ["Whey protein (30g)", "Dextrose (20g)"],
          maintain: ["Whey protein (30g)", "Banana", "Aveia (30g)"],
          gain: ["Whey protein (40g)", "Dextrose (30g)", "Creatina (5g)", "Glutamina (5g)"]
        }
      },
      {
        name: "Jantar",
        icon: "üåô",
        options: {
          lose: ["Peixe grelhado (150g)", "Quinoa (60g)", "Aspargos", "Salada verde"],
          maintain: ["Frango/Peixe (180g)", "Arroz integral (80g)", "Legumes grelhados (200g)"],
          gain: ["Salm√£o (200g)", "Arroz integral (100g)", "Batata doce (150g)", "Br√≥colis (200g)", "Azeite"]
        }
      },
      {
        name: "Ceia",
        icon: "üåú",
        options: {
          lose: ["Case√≠na (30g) ou Iogurte grego"],
          maintain: ["Queijo cottage (100g)", "Castanhas (15g)"],
          gain: ["Case√≠na (40g)", "Pasta de amendoim (20g)", "Aveia (30g)"]
        }
      }
    ];

    // Calculations
    function calculateTMB(weight, height, age, gender) {
      return gender === 'male' 
        ? 10 * weight + 6.25 * height - 5 * age + 5
        : 10 * weight + 6.25 * height - 5 * age - 161;
    }

    function calculateTDEE(tmb, activityLevel) {
      return tmb * parseFloat(activityLevel);
    }

    function calculateGoalCalories(tdee, goal) {
      const adjustments = { lose: -500, maintain: 0, gain: 300 };
      return Math.round(tdee + (adjustments[goal] || 0));
    }

    function calculateMacros(calories, weight, goal) {
      const proteinMultiplier = { lose: 2.2, maintain: 2.0, gain: 2.0 };
      const protein = Math.round(weight * proteinMultiplier[goal]);
      const proteinCals = protein * 4;
      
      const fatMultiplier = { lose: 0.8, maintain: 1.0, gain: 1.0 };
      const fat = Math.round(weight * fatMultiplier[goal]);
      const fatCals = fat * 9;
      
      const carbCals = calories - proteinCals - fatCals;
      const carbs = Math.round(carbCals / 4);
      
      return { protein, carbs, fat };
    }

    function calculateWaterGoal(weight, activityLevel, trainingDays) {
      const baseWater = weight * 0.035;
      const activityBonus = parseFloat(activityLevel) > 1.55 ? 0.5 : 0;
      const trainingBonus = (trainingDays / 7) * 0.5;
      return (baseWater + activityBonus + trainingBonus).toFixed(1);
    }

    // Bluetooth Functions
    async function connectBluetoothScale() {
      const statusDiv = document.getElementById('bluetooth-status');
      const btnText = document.getElementById('bluetooth-btn-text');
      const dataDiv = document.getElementById('bluetooth-data');
      
      if (!navigator.bluetooth) {
        showInlineMessage(statusDiv, '‚ö†Ô∏è Bluetooth n√£o suportado neste navegador. Use Chrome ou Edge no desktop.', 'error');
        return;
      }
      
      try {
        btnText.textContent = 'Procurando...';
        statusDiv.innerHTML = '<div class="flex items-center space-x-2"><div class="w-3 h-3 bg-blue-400 rounded-full bluetooth-scan"></div><span class="text-blue-400">Selecione sua balan√ßa na janela...</span></div>';
        
        // Simplified request to accept any Bluetooth device
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['body_composition', 'weight_scale', 'device_information', 'battery_service', '0000181b-0000-1000-8000-00805f9b34fb', '0000181d-0000-1000-8000-00805f9b34fb']
        });
        
        showInlineMessage(statusDiv, `‚úÖ Conectado: ${device.name || 'Balan√ßa Bluetooth'}`, 'success');
        btnText.textContent = 'Conectado';
        document.getElementById('sync-indicator').classList.remove('hidden');
        
        statusDiv.innerHTML += '<p class="text-xs text-yellow-400 mt-2">üìä Lendo dados da balan√ßa...</p>';
        
        try {
          const server = await device.gatt.connect();
          
          // Try to get real data from device
          let realData = null;
          try {
            const service = await server.getPrimaryService('body_composition').catch(() => 
              server.getPrimaryService('weight_scale').catch(() => null)
            );
            
            if (service) {
              const characteristic = await service.getCharacteristic('weight_measurement').catch(() => null);
              if (characteristic) {
                const value = await characteristic.readValue();
                // Parse weight from characteristic (implementation depends on device)
                realData = parseWeightData(value);
              }
            }
          } catch (e) {
            console.log('Could not read real data, using demo mode');
          }
          
          // Fallback to simulated data if real data unavailable
          const mockData = realData || {
            weight: (65 + Math.random() * 30).toFixed(1),
            bodyFat: (15 + Math.random() * 15).toFixed(1),
            muscleMass: (25 + Math.random() * 15).toFixed(1),
            waterPercent: (50 + Math.random() * 15).toFixed(1)
          };
          
          dataDiv.classList.remove('hidden');
          dataDiv.innerHTML = `
            <div class="bg-purple-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">Peso</p>
              <p class="text-lg font-bold">${mockData.weight} kg</p>
            </div>
            <div class="bg-green-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">Gordura</p>
              <p class="text-lg font-bold">${mockData.bodyFat}%</p>
            </div>
            <div class="bg-blue-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">M√∫sculo</p>
              <p class="text-lg font-bold">${mockData.muscleMass} kg</p>
            </div>
            <div class="bg-cyan-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">√Ågua</p>
              <p class="text-lg font-bold">${mockData.waterPercent}%</p>
            </div>
          `;
          
          if (!realData) {
            statusDiv.innerHTML += '<p class="text-xs text-yellow-400 mt-2">‚ÑπÔ∏è Dados simulados (sua balan√ßa pode n√£o ser totalmente compat√≠vel)</p>';
          }
          
          document.getElementById('weight').value = mockData.weight;
          document.getElementById('bodyfat').value = mockData.bodyFat;
          document.getElementById('muscle').value = mockData.muscleMass;
          
        } catch (connectError) {
          // Even if GATT connection fails, show simulated data
          console.log('GATT connection failed, using demo data');
          const mockData = {
            weight: (70 + Math.random() * 20).toFixed(1),
            bodyFat: (18 + Math.random() * 10).toFixed(1),
            muscleMass: (30 + Math.random() * 10).toFixed(1),
            waterPercent: (55 + Math.random() * 10).toFixed(1)
          };
          
          dataDiv.classList.remove('hidden');
          dataDiv.innerHTML = `
            <div class="bg-purple-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">Peso</p>
              <p class="text-lg font-bold">${mockData.weight} kg</p>
            </div>
            <div class="bg-green-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">Gordura</p>
              <p class="text-lg font-bold">${mockData.bodyFat}%</p>
            </div>
            <div class="bg-blue-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">M√∫sculo</p>
              <p class="text-lg font-bold">${mockData.muscleMass} kg</p>
            </div>
            <div class="bg-cyan-500/10 rounded-lg p-3 text-center">
              <p class="text-xs text-gray-400">√Ågua</p>
              <p class="text-lg font-bold">${mockData.waterPercent}%</p>
            </div>
          `;
          
          statusDiv.innerHTML += '<p class="text-xs text-yellow-400 mt-2">‚ö†Ô∏è Modo demonstra√ß√£o - ajuste os valores manualmente</p>';
          
          document.getElementById('weight').value = mockData.weight;
          document.getElementById('bodyfat').value = mockData.bodyFat;
          document.getElementById('muscle').value = mockData.muscleMass;
        }
        
      } catch (error) {
        console.error('Bluetooth error:', error);
        
        if (error.name === 'NotFoundError') {
          showInlineMessage(statusDiv, '‚ùå Nenhum dispositivo selecionado. Tente novamente.', 'error');
        } else if (error.name === 'SecurityError') {
          statusDiv.innerHTML = `
            <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 space-y-3">
              <p class="text-red-400 font-semibold flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span>Bluetooth Bloqueado</span>
              </p>
              <div class="text-sm text-gray-300 space-y-2">
                <p class="font-medium">Como desbloquear:</p>
                <div class="space-y-2 ml-4">
                  <p class="flex items-start space-x-2">
                    <span class="text-blue-400 font-bold">1.</span>
                    <span>Clique no √≠cone de <strong>cadeado üîí</strong> ou <strong>informa√ß√µes ‚ìò</strong> na barra de endere√ßo (canto superior esquerdo)</span>
                  </p>
                  <p class="flex items-start space-x-2">
                    <span class="text-blue-400 font-bold">2.</span>
                    <span>Procure por <strong>"Bluetooth"</strong> nas configura√ß√µes</span>
                  </p>
                  <p class="flex items-start space-x-2">
                    <span class="text-blue-400 font-bold">3.</span>
                    <span>Altere de "Bloquear" para <strong>"Perguntar"</strong> ou <strong>"Permitir"</strong></span>
                  </p>
                  <p class="flex items-start space-x-2">
                    <span class="text-blue-400 font-bold">4.</span>
                    <span>Recarregue a p√°gina (F5) e tente conectar novamente</span>
                  </p>
                </div>
                <div class="mt-3 p-3 bg-blue-500/10 rounded-lg">
                  <p class="text-xs text-blue-300">
                    üí° <strong>Dica:</strong> Use Google Chrome ou Microsoft Edge para melhor compatibilidade com Bluetooth
                  </p>
                </div>
              </div>
            </div>
          `;
        } else if (error.name === 'NotSupportedError') {
          showInlineMessage(statusDiv, '‚ùå Dispositivo n√£o suportado. Preencha manualmente.', 'error');
        } else {
          showInlineMessage(statusDiv, `‚ùå Erro: ${error.message || 'Conex√£o falhou'}. Use entrada manual.`, 'error');
        }
        
        btnText.textContent = 'Tentar Novamente';
      }
    }
    
    function parseWeightData(dataView) {
      // Basic parser for weight scale data (varies by manufacturer)
      // This is a simplified version - real implementation depends on device specs
      try {
        const weight = dataView.getUint16(1, true) / 200; // Example parsing
        return {
          weight: weight.toFixed(1),
          bodyFat: null,
          muscleMass: null,
          waterPercent: null
        };
      } catch (e) {
        return null;
      }
    }

    function showInlineMessage(container, message, type) {
      const colors = {
        success: 'text-green-400',
        error: 'text-red-400',
        info: 'text-blue-400'
      };
      container.innerHTML = `<p class="${colors[type]} text-sm">${message}</p>`;
    }

    // Render Functions
    function renderWorkoutPlan(trainingDays, level) {
      const workoutPlan = document.getElementById('workout-plan');
      const program = workoutPrograms[trainingDays][level];
      
      const levelBadge = document.getElementById('workout-level-badge');
      const levelNames = { beginner: 'Iniciante', intermediate: 'Intermedi√°rio', advanced: 'Avan√ßado' };
      levelBadge.textContent = levelNames[level];
      
      workoutPlan.innerHTML = program.map((day, dayIndex) => {
        const exercises = day.groups.flatMap(([group, count]) => 
          advancedExercises[group] && advancedExercises[group][level] 
            ? advancedExercises[group][level].slice(0, count) 
            : []
        );
        
        return `
          <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl p-5 border border-purple-500/20 card-hover">
            <div class="flex items-center justify-between mb-4">
              <h4 class="font-bold text-lg text-purple-300">${day.name}</h4>
              <span class="px-3 py-1 bg-purple-500/20 rounded-lg text-xs font-semibold">${exercises.length} exerc√≠cios</span>
            </div>
            <div class="space-y-3">
              ${exercises.map((ex, idx) => `
                <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center space-x-2 mb-2">
                        <span class="flex items-center justify-center w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg text-xs font-bold">${idx + 1}</span>
                        <p class="font-semibold text-white">${ex.name}</p>
                      </div>
                      <div class="flex flex-wrap gap-3 text-sm mb-2">
                        <span class="flex items-center space-x-1">
                          <span class="text-purple-400 font-medium">${ex.sets}</span>
                          <span class="text-gray-400">s√©ries</span>
                        </span>
                        <span class="flex items-center space-x-1">
                          <span class="text-pink-400 font-medium">${ex.reps}</span>
                          <span class="text-gray-400">reps</span>
                        </span>
                        <span class="flex items-center space-x-1">
                          <span class="text-blue-400 font-medium">${ex.rest}</span>
                          <span class="text-gray-400">desc</span>
                        </span>
                      </div>
                      <p class="text-xs text-gray-400 italic">üí° ${ex.note}</p>
                    </div>
                    <div class="w-10 h-10 gradient-primary rounded-lg flex items-center justify-center ml-3 flex-shrink-0">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                      </svg>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="mt-4 p-3 bg-blue-500/10 rounded-lg">
              <p class="text-xs text-blue-300 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span><strong>Progress√£o:</strong> Aumente 2-5% da carga ou 1-2 reps a cada semana</span>
              </p>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDietPlan(calories, macros, goal) {
      const dietPlan = document.getElementById('diet-plan');
      const mealsPerDay = mealDatabase.length;
      const caloriesPerMeal = Math.round(calories / mealsPerDay);
      
      dietPlan.innerHTML = mealDatabase.map((meal, index) => {
        const mealProtein = Math.round(macros.protein / mealsPerDay);
        const mealCarbs = Math.round(macros.carbs / mealsPerDay);
        const mealFat = Math.round(macros.fat / mealsPerDay);
        const foods = meal.options[goal] || meal.options.maintain;
        
        return `
          <div class="bg-gradient-to-br from-pink-500/10 to-purple-500/10 rounded-2xl p-5 border border-pink-500/20 card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-3">
                <span class="text-3xl">${meal.icon}</span>
                <h4 class="font-bold text-lg text-pink-300">${meal.name}</h4>
              </div>
              <span class="text-xl font-bold text-white">${caloriesPerMeal} kcal</span>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4 p-3 bg-white/5 rounded-lg">
              <div class="text-center">
                <p class="text-xs text-gray-400">Prote√≠na</p>
                <p class="text-sm font-bold text-green-400">${mealProtein}g</p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-400">Carbo</p>
                <p class="text-sm font-bold text-blue-400">${mealCarbs}g</p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-400">Gordura</p>
                <p class="text-sm font-bold text-yellow-400">${mealFat}g</p>
              </div>
            </div>
            
            <div class="space-y-2">
              <p class="text-xs text-gray-400 font-medium mb-2">ÔøΩÔøΩ Alimentos sugeridos:</p>
              ${foods.map(food => `
                <div class="flex items-center space-x-2 text-sm bg-white/5 rounded-lg p-2">
                  <span class="w-2 h-2 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex-shrink-0"></span>
                  <span class="text-gray-300">${food}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateMacrosChart(macros) {
      const ctx = document.getElementById('macros-chart');
      if (!ctx) return;
      
      if (macrosChart) {
        macrosChart.destroy();
      }
      
      macrosChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Prote√≠na', 'Carboidratos', 'Gorduras'],
          datasets: [{
            data: [macros.protein * 4, macros.carbs * 4, macros.fat * 9],
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',
              'rgba(59, 130, 246, 0.8)',
              'rgba(234, 179, 8, 0.8)'
            ],
            borderColor: [
              'rgba(34, 197, 94, 1)',
              'rgba(59, 130, 246, 1)',
              'rgba(234, 179, 8, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: '#fff',
                font: { size: 12 },
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + Math.round(context.parsed) + ' kcal';
                }
              }
            }
          }
        }
      });
    }

    function updateWaterProgress() {
      const percent = Math.min((waterIntake / waterGoal) * 100, 100);
      document.getElementById('water-current').textContent = waterIntake.toFixed(1);
      document.getElementById('water-progress').style.width = percent + '%';
      document.getElementById('water-percent').textContent = Math.round(percent) + '%';
    }

    async function saveWaterData() {
      if (!window.dataSdk) return;
      
      const today = new Date().toISOString().split('T')[0];
      const result = await window.dataSdk.create({
        id: `water-${today}-${Date.now()}`,
        type: 'water',
        date: today,
        weight: userData?.weight || 0,
        bodyFat: userData?.bodyfat || 0,
        muscleMass: userData?.muscle || 0,
        waterPercent: 0,
        waterIntake: waterIntake,
        notes: ''
      });
      
      if (!result.isOk) {
        console.error('Failed to save water data');
      }
    }

    // Screen Navigation
    function showScreen(screenId) {
      ['welcome-screen', 'profile-setup', 'dashboard'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }

    // Event Handlers
    document.getElementById('start-btn').addEventListener('click', () => showScreen('profile-setup'));
    document.getElementById('bluetooth-welcome-btn').addEventListener('click', () => {
      showScreen('profile-setup');
      setTimeout(() => connectBluetoothScale(), 300);
    });

    document.getElementById('bluetooth-btn').addEventListener('click', connectBluetoothScale);

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('generate-plan-btn');
      btn.disabled = true;
      btn.textContent = 'Gerando plano...';
      
      userData = {
        weight: parseFloat(document.getElementById('weight').value),
        height: parseFloat(document.getElementById('height').value),
        age: parseInt(document.getElementById('age').value),
        gender: document.getElementById('gender').value,
        bodyfat: parseFloat(document.getElementById('bodyfat').value) || null,
        muscle: parseFloat(document.getElementById('muscle').value) || null,
        activity: document.getElementById('activity').value,
        goal: document.getElementById('goal').value,
        trainingDays: parseInt(document.getElementById('training-days').value),
        level: document.getElementById('level').value
      };
      
      const tmb = calculateTMB(userData.weight, userData.height, userData.age, userData.gender);
      const tdee = calculateTDEE(tmb, userData.activity);
      const goalCalories = calculateGoalCalories(tdee, userData.goal);
      const macros = calculateMacros(goalCalories, userData.weight, userData.goal);
      waterGoal = parseFloat(calculateWaterGoal(userData.weight, userData.activity, userData.trainingDays));
      
      calculatedData = { tmb, tdee, goalCalories, macros };
      
      document.getElementById('tmb-value').textContent = Math.round(tmb);
      document.getElementById('tdee-value').textContent = Math.round(tdee);
      document.getElementById('goal-calories').textContent = goalCalories;
      document.getElementById('protein-value').textContent = macros.protein + 'g';
      
      const totalGrams = macros.protein + macros.carbs + macros.fat;
      document.getElementById('protein-grams').textContent = `${macros.protein}g (${Math.round((macros.protein/totalGrams)*100)}%)`;
      document.getElementById('carbs-grams').textContent = `${macros.carbs}g (${Math.round((macros.carbs/totalGrams)*100)}%)`;
      document.getElementById('fat-grams').textContent = `${macros.fat}g (${Math.round((macros.fat/totalGrams)*100)}%)`;
      
      document.getElementById('protein-bar').style.width = (macros.protein / totalGrams * 100) + '%';
      document.getElementById('carbs-bar').style.width = (macros.carbs / totalGrams * 100) + '%';
      document.getElementById('fat-bar').style.width = (macros.fat / totalGrams * 100) + '%';
      
      document.getElementById('water-goal').textContent = waterGoal;
      waterIntake = 0;
      updateWaterProgress();
      
      renderWorkoutPlan(userData.trainingDays, userData.level);
      renderDietPlan(goalCalories, macros, userData.goal);
      updateMacrosChart(macros);
      
      if (window.dataSdk) {
        await window.dataSdk.create({
          id: `profile-${Date.now()}`,
          type: 'profile',
          date: new Date().toISOString(),
          weight: userData.weight,
          bodyFat: userData.bodyfat || 0,
          muscleMass: userData.muscle || 0,
          waterPercent: 0,
          waterIntake: 0,
          notes: JSON.stringify(userData)
        });
      }
      
      btn.disabled = false;
      btn.textContent = 'Gerar Plano Personalizado';
      showScreen('dashboard');

      // Auto-save generated plan (melhor pr√°tica): cria um treino com nome padr√£o e pessoa opcional
      try {
        const autoName = `Plano ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
        const personField = document.getElementById('save-workout-person');
        const personValue = personField ? personField.value.trim() : '';
        const program = (window.workoutPrograms && window.workoutPrograms[userData.trainingDays]) ? window.workoutPrograms[userData.trainingDays][userData.level] : null;
        const payload = {
          user: userData,
          calculated: calculatedData,
          program: program,
          macros: macros,
          diet: buildDietPayload(goalCalories, macros, userData.goal)
        };
        // Salva automaticamente ‚Äî o usu√°rio pode renomear/apagar depois na lista
        saveWorkout(autoName, personValue, payload);
        // feedback visual simples
        try { document.getElementById('sync-indicator').classList.remove('hidden'); setTimeout(()=>document.getElementById('sync-indicator').classList.add('hidden'), 2500); } catch(e){}
      } catch(e) {
        console.error('Erro ao autosalvar plano', e);
      }
    });

    document.querySelectorAll('.water-add-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const amount = parseFloat(btn.dataset.amount);
        waterIntake += amount;
        updateWaterProgress();
        await saveWaterData();
      });
    });

    document.getElementById('water-reset-btn').addEventListener('click', async () => {
      waterIntake = 0;
      updateWaterProgress();
      await saveWaterData();
    });

    document.getElementById('edit-profile-btn').addEventListener('click', () => showScreen('profile-setup'));
    document.getElementById('new-plan-btn').addEventListener('click', () => {
      if (userData && calculatedData) {
        renderWorkoutPlan(userData.trainingDays, userData.level);
        renderDietPlan(calculatedData.goalCalories, calculatedData.macros, userData.goal);
      }
    });

    // Config Management
    async function onConfigChange(config) {
      currentConfig = config;
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('welcome-title').textContent = config.welcome_title || defaultConfig.welcome_title;
      document.getElementById('welcome-subtitle').textContent = config.welcome_subtitle || defaultConfig.welcome_subtitle;
      document.getElementById('water-goal-label').textContent = config.water_goal_label || defaultConfig.water_goal_label;
    }

    const dataHandler = {
      onDataChanged(data) {
        try{
          // Render saved workouts coming from the backend (type: 'workout_plan')
          const workoutPlans = (data || []).filter(d => d.type === 'workout_plan' || d.type === 'workout');
          if(workoutPlans && workoutPlans.length) {
            renderSavedWorkouts(workoutPlans);
          } else {
            // hide section if none
            const section = document.getElementById('saved-workouts-section');
            if(section) section.classList.add('hidden');
          }
        }catch(e){
          console.error('dataHandler.onDataChanged error', e);
        }
      }
    };

    // Initialize
    async function initApp() {
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || '#a855f7',
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['welcome_title', config.welcome_title || defaultConfig.welcome_title],
            ['welcome_subtitle', config.welcome_subtitle || defaultConfig.welcome_subtitle],
            ['water_goal_label', config.water_goal_label || defaultConfig.water_goal_label],
            ['bluetooth_button_text', config.bluetooth_button_text || defaultConfig.bluetooth_button_text]
          ])
        });
      }
    }

    initApp();

    // -----------------------------
    // Saved workouts (localStorage)
    // -----------------------------
    const WORKOUTS_KEY = 'fp_workouts_v1';

    function getSavedWorkouts(){
      try{
        return JSON.parse(localStorage.getItem(WORKOUTS_KEY) || '[]');
      }catch(e){
        console.error('Erro ao ler treinos salvos', e);
        return [];
      }
    }

    function setSavedWorkouts(arr){
      localStorage.setItem(WORKOUTS_KEY, JSON.stringify(arr));
    }

    // Build a simple diet payload (meals) from calories/macros and goal
    function buildDietPayload(calories, macros, goal){
      try{
        const mealsPerDay = window.mealDatabase ? window.mealDatabase.length : 3;
        const caloriesPerMeal = Math.round(calories / mealsPerDay);
        const meals = (window.mealDatabase || []).map((meal, index) => ({
          name: meal.name,
          calories: caloriesPerMeal,
          protein: Math.round(macros.protein / mealsPerDay),
          carbs: Math.round(macros.carbs / mealsPerDay),
          fat: Math.round(macros.fat / mealsPerDay),
          options: meal.options && meal.options[goal] ? meal.options[goal] : meal.options
        }));
        return { calories, macros, goal, meals };
      }catch(e){
        console.error('Erro ao montar dieta', e);
        return { calories, macros, goal, meals: [] };
      }
    }

    function saveWorkout(name, person, payload){
      if(!name) return;
      const list = getSavedWorkouts();
      const item = { id: Date.now(), name: name.trim(), person: (person||'').trim(), payload: payload||{}, created: new Date().toISOString() };
      list.unshift(item);
      setSavedWorkouts(list);
      renderLocalSavedWorkouts();
      try{ renderWelcomeSavedLists(); }catch(e){}
    }

    function deleteWorkout(id){
      const list = getSavedWorkouts().filter(i => i.id !== id);
      setSavedWorkouts(list);
      renderLocalSavedWorkouts();
    }

    function loadWorkoutToUI(item){
      // carrega apenas informa√ß√µes simples na √°rea de treino
      const container = document.getElementById('workout-plan');
      if(!container) return;
      container.innerHTML = '';
      const el = document.createElement('div');
      el.className = 'p-4 bg-gray-900/40 rounded-xl border border-white/5';
      el.innerHTML = `<div class="flex items-center justify-between"><div><h4 class="font-bold text-lg">${escapeHtml(item.name)}</h4><p class="text-sm text-gray-400">Pessoa: ${escapeHtml(item.person||'‚Äî')}</p></div><div class="text-xs text-gray-400">Salvo em ${new Date(item.created).toLocaleString()}</div></div><div class="mt-3 text-sm text-gray-300">${item.payload && item.payload.note ? escapeHtml(item.payload.note) : ''}</div>`;
      container.appendChild(el);
    }

    function renderLocalSavedWorkouts(){
      const ul = document.getElementById('saved-workouts');
      if(!ul) return;
      const list = getSavedWorkouts();
      ul.innerHTML = '';
      if(list.length === 0){
        const li = document.createElement('li');
        li.className = 'text-sm text-gray-400';
        li.textContent = 'Nenhum treino salvo ainda.';
        ul.appendChild(li);
        return;
      }
      list.forEach(item => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-800/40 p-3 rounded-xl border border-white/5';
        const left = document.createElement('div');
        left.innerHTML = `<div class="font-semibold">${escapeHtml(item.name)}</div><div class="text-xs text-gray-400">${escapeHtml(item.person||'‚Äî')}</div>`;
        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-2';
        const loadBtn = document.createElement('button');
        loadBtn.className = 'px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 rounded-md text-sm';
        loadBtn.textContent = 'Carregar';
        loadBtn.onclick = () => loadWorkoutToUI(item);
        const delBtn = document.createElement('button');
        delBtn.className = 'px-3 py-1 bg-red-500/20 hover:bg-red-500/30 rounded-md text-sm';
        delBtn.textContent = 'Apagar';
        delBtn.onclick = () => { if(confirm('Apagar este treino?')) deleteWorkout(item.id); };
        actions.appendChild(loadBtn);
        actions.appendChild(delBtn);
        li.appendChild(left);
        li.appendChild(actions);
        ul.appendChild(li);
      });
    }

    // Render small previews on the welcome screen
    function renderWelcomeSavedLists(){
      const containerW = document.getElementById('welcome-saved-workouts');
      const containerD = document.getElementById('welcome-saved-diets');
      if(containerW) containerW.innerHTML = '';
      if(containerD) containerD.innerHTML = '';
      const list = getSavedWorkouts();
      if(!list || list.length === 0){
        if(containerW) containerW.innerHTML = '<div class="text-sm text-gray-400">Nenhum treino salvo.</div>';
        if(containerD) containerD.innerHTML = '<div class="text-sm text-gray-400">Nenhuma dieta salva.</div>';
        return;
      }
      // show up to 4 recent items
      const recent = list.slice(0, 6);
      recent.forEach(item => {
        const hasProgram = item.payload && item.payload.program;
        const hasDiet = item.payload && (item.payload.diet || item.payload.meals || item.payload.macros);
        if(hasProgram && containerW){
          const el = document.createElement('div');
          el.className = 'p-3 bg-gray-800/30 rounded-xl flex items-center justify-between';
          el.innerHTML = `<div><div class="font-semibold">${escapeHtml(item.name)}</div><div class="text-xs text-gray-400">${escapeHtml(item.person||'‚Äî')}</div></div><div class="text-xs text-gray-400">${new Date(item.created).toLocaleDateString()}</div>`;
          el.onclick = () => loadWorkoutToUI(item);
          containerW.appendChild(el);
        }
        if(hasDiet && containerD){
          const el = document.createElement('div');
          el.className = 'p-3 bg-gray-800/30 rounded-xl flex items-center justify-between';
          el.innerHTML = `<div><div class="font-semibold">${escapeHtml(item.name)}<span class="ml-2 text-xs text-gray-300">(dieta)</span></div><div class="text-xs text-gray-400">${escapeHtml(item.person||'‚Äî')}</div></div><div class="text-xs text-gray-400">${new Date(item.created).toLocaleDateString()}</div>`;
          el.onclick = () => { loadWorkoutToUI(item); /* same loader shows summary including diet */ };
          containerD.appendChild(el);
        }
      });
    }

    // Render saved workouts coming from backend dataSdk
    function renderSavedWorkouts(workouts){
      const section = document.getElementById('saved-workouts-section');
      const list = document.getElementById('saved-workouts-list');
      const badge = document.getElementById('workout-count-badge');
      if(!section || !list || !badge) return;

      if(!workouts || workouts.length === 0){
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      badge.textContent = `${workouts.length} treino${workouts.length > 1 ? 's' : ''}`;

      list.innerHTML = workouts.map(workout => {
        const workoutData = workout.notes ? JSON.parse(workout.notes) : {};
        const date = workout.date ? new Date(workout.date).toLocaleDateString('pt-BR') : '';
        const levelNames = { beginner: 'Iniciante', intermediate: 'Intermedi√°rio', advanced: 'Avan√ßado' };
        const levelName = levelNames[workoutData.level] || 'N/A';
        const calories = workoutData.goalCalories || workoutData.calories || 0;
        const protein = (workoutData.macros && workoutData.macros.protein) ? workoutData.macros.protein : (workoutData.protein || 0);
        const weight = workoutData.weight || 0;
        const backendId = workout.__backendId || workout.id || workout._id || '';

        return `
          <div class="glass-effect rounded-xl p-5 border border-purple-500/30 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <h4 class="font-bold text-lg text-white mb-1">${escapeHtml(workout.name || 'Treino Personalizado')}</h4>
                <p class="text-xs text-gray-400">${date}</p>
              </div>
              <span class="px-2 py-1 bg-purple-500/20 rounded-lg text-xs font-semibold">${levelName}</span>
            </div>
            <div class="space-y-2 mb-4">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">Calorias:</span>
                <span class="font-semibold text-pink-400">${calories} kcal</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">Prote√≠na:</span>
                <span class="font-semibold text-green-400">${protein}g</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-400">Peso:</span>
                <span class="font-semibold text-blue-400">${weight}kg</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="open-workout-btn flex-1 px-4 py-2 gradient-primary rounded-lg font-semibold text-sm hover:scale-105 transition-all" data-workout-id="${escapeHtml(backendId)}">Abrir</button>
              <button class="delete-workout-btn px-4 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg font-semibold text-sm transition-all" data-workout-id="${escapeHtml(backendId)}"> <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
            </div>
          </div>
        `;
      }).join('');

      // attach listeners
      list.querySelectorAll('.open-workout-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const workoutId = btn.dataset.workoutId;
          loadWorkout(workoutId, workouts);
        });
      });

      list.querySelectorAll('.delete-workout-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const workoutId = btn.dataset.workoutId;
          const workout = workouts.find(w => (w.__backendId || w.id || w._id || '') === workoutId);
          if(workout){
            btn.disabled = true;
            const prev = btn.innerHTML;
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            try{
              const result = await window.dataSdk.delete(workout);
              if(!result || !result.isOk){
                console.error('Failed to delete workout');
                btn.disabled = false;
                btn.innerHTML = prev;
              }
            }catch(e){
              console.error('delete error', e);
              btn.disabled = false;
              btn.innerHTML = prev;
            }
          }
        });
      });
    }

    // Load a saved workout from backend list into the UI
    function loadWorkout(workoutId, workouts){
      const workout = workouts.find(w => (w.__backendId || w.id || w._id || '') === workoutId);
      if(!workout || !workout.notes) return;
      let workoutData = {};
      try{ workoutData = JSON.parse(workout.notes); }catch(e){ console.error('invalid workout notes', e); return; }

      // populate form fields
      document.getElementById('weight').value = workoutData.weight || '';
      document.getElementById('height').value = workoutData.height || '';
      document.getElementById('age').value = workoutData.age || '';
      document.getElementById('gender').value = workoutData.gender || 'male';
      document.getElementById('bodyfat').value = workoutData.bodyfat || '';
      document.getElementById('muscle').value = workoutData.muscle || '';
      document.getElementById('activity').value = workoutData.activity || '1.55';
      document.getElementById('goal').value = workoutData.goal || 'maintain';
      document.getElementById('training-days').value = workoutData.trainingDays || 5;
      document.getElementById('level').value = workoutData.level || 'intermediate';

      userData = workoutData;

      const tmb = calculateTMB(workoutData.weight, workoutData.height, workoutData.age, workoutData.gender);
      const tdee = calculateTDEE(tmb, workoutData.activity);
      const goalCalories = calculateGoalCalories(tdee, workoutData.goal);
      const macros = calculateMacros(goalCalories, workoutData.weight, workoutData.goal);
      waterGoal = parseFloat(calculateWaterGoal(workoutData.weight, workoutData.activity, workoutData.trainingDays));

      calculatedData = { tmb, tdee, goalCalories, macros };

      document.getElementById('tmb-value').textContent = Math.round(tmb);
      document.getElementById('tdee-value').textContent = Math.round(tdee);
      document.getElementById('goal-calories').textContent = goalCalories;
      document.getElementById('protein-value').textContent = macros.protein + 'g';

      const totalGrams = macros.protein + macros.carbs + macros.fat;
      document.getElementById('protein-grams').textContent = `${macros.protein}g (${Math.round((macros.protein/totalGrams)*100)}%)`;
      document.getElementById('carbs-grams').textContent = `${macros.carbs}g (${Math.round((macros.carbs/totalGrams)*100)}%)`;
      document.getElementById('fat-grams').textContent = `${macros.fat}g (${Math.round((macros.fat/totalGrams)*100)}%)`;

      document.getElementById('protein-bar').style.width = (macros.protein / totalGrams * 100) + '%';
      document.getElementById('carbs-bar').style.width = (macros.carbs / totalGrams * 100) + '%';
      document.getElementById('fat-bar').style.width = (macros.fat / totalGrams * 100) + '%';

      document.getElementById('water-goal').textContent = waterGoal;
      updateWaterProgress();

      renderWorkoutPlan(workoutData.trainingDays, workoutData.level);
      renderDietPlan(goalCalories, macros, workoutData.goal);
      updateMacrosChart(macros);

      showScreen('dashboard');
    }

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]);
    }

    // Wire up save button
    (function(){
      const btn = document.getElementById('save-workout-btn');
      if(btn){
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const name = document.getElementById('save-workout-name').value || '';
          const person = document.getElementById('save-workout-person').value || '';
          // you could capture more of the current plan here (payload)
          const payload = { note: `Plano salvo para ${person || 'Usu√°rio'}` };
          if(!name.trim()){
            alert('Digite um nome para o treino.');
            return;
          }
          saveWorkout(name, person, payload);
          document.getElementById('save-workout-name').value = '';
          document.getElementById('save-workout-person').value = '';
        });
      }
      // render on load
  try{ renderLocalSavedWorkouts(); renderWelcomeSavedLists(); }catch(e){console.error(e)}
    })();

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b94be5dd4128dd8',t:'MTc2NzYzNDY0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>